# Tests Firmware retraction G10 and G11 with Virtual SD Card ENABLED

DICTIONARY atmega2560.dict
CONFIG firmware_retraction_with_VSDCard.cfg

CLEAR_RETRACTION
G90
VERIFY_AXIS_POSITION AXIS=e EXPECTED=0.0

################################### CHECK DISABLED RETRACTION WITH ZHOP DISABLED
G28
SET_RETRACTION RETRACT_LENGTH=0.0 UNRETRACT_EXTRA_LENGTH=0.0 Z_HOP_HEIGHT=0.0
G10
VERIFY_AXIS_POSITION AXIS=e EXPECTED=0.0
G11
VERIFY_AXIS_POSITION AXIS=e EXPECTED=0.0

############# CHECK RETRACTION CLEAR ON STEPPER DISABLE EVENT WITH ZHOP DISABLED
SET_RETRACTION RETRACT_LENGTH=2.5 UNRETRACT_EXTRA_LENGTH=1.0 Z_HOP_HEIGHT=0.0
G10
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-2.5
M84
CHECK_RECTRACTION_CLEARED

###################### CHECK RETRACTION CLEAR ON HOMING EVENT WITH ZHOP DISABLED
G28
SET_RETRACTION RETRACT_LENGTH=2.5 UNRETRACT_EXTRA_LENGTH=1.0 Z_HOP_HEIGHT=0.0
G10
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-5.0
G28
CHECK_RECTRACTION_CLEARED

############## CHECK RETRACTION CLEAR ON STEPPER DISABLE EVENT WITH ZHOP ENABLED
SET_RETRACTION RETRACT_LENGTH=2.5 UNRETRACT_EXTRA_LENGTH=1.0 Z_HOP_HEIGHT=2.0
G10
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-7.5
M84
CHECK_RECTRACTION_CLEARED

####################### CHECK RETRACTION CLEAR ON HOMING EVENT WITH ZHOP ENABLED
G28
SET_RETRACTION RETRACT_LENGTH=2.5 UNRETRACT_EXTRA_LENGTH=1.0 Z_HOP_HEIGHT=2.0
G10
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-10.0
G28
CHECK_RECTRACTION_CLEARED

############################################## SET PRINTER UP FOR MOVEMENT TESTS
SET_RETRACTION RETRACT_LENGTH=2.5 UNRETRACT_EXTRA_LENGTH=1.0 Z_HOP_HEIGHT=0.0
G1 X100.0 Y100.0 Z20.0
G91
G1 E10.0
G90

####################################################### TESTING FW WITHOUT Z_HOP

# Unretract in unretract state
G11
VERIFY_AXIS_POSITION AXIS=e EXPECTED=0.0

# Retract in unretract state
G10
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-2.5

# Repeat Retract
G10
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-2.5

# Unretract in retract state
G11
VERIFY_AXIS_POSITION AXIS=e EXPECTED=1.0

# Second round: Retract in unretract state
G10
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-1.5

# Second round: Unretract in retract state
G11
VERIFY_AXIS_POSITION AXIS=e EXPECTED=2.0
# Compensate for second round
G91
G1 E-1.0
G90

###################################################### TESTING FW Z_HOP STANDARD

SET_RETRACTION UNRETRACT_EXTRA_LENGTH=0.0
SET_RETRACTION Z_HOP_HEIGHT=2.0

# Retract with Standard zhop
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=22.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-1.5

# Repeat retract with Standard zhop
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=22.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-1.5

# Unretract with Standard zhop in retract state
G11
VERIFY_AXIS_POSITION AXIS=z EXPECTED=20.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=1.0

# Second round: Retract with Standard zhop
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=22.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-1.5

# Second round: Unretract with Standard zhop in retract state
G11
VERIFY_AXIS_POSITION AXIS=z EXPECTED=20.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=1.0

#################################### TESTING CHANGE Z_HOP_HEIGHT WHILE RETRACTED

G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=22.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-1.5
SET_RETRACTION Z_HOP_HEIGHT=3.0
G11
VERIFY_AXIS_POSITION AXIS=z EXPECTED=20.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=1.0

################ TESTING MOVE Z WHILE RETRACTED WITH SWITCH TO RELATIVE AND BACK

SET_RETRACTION Z_HOP_HEIGHT=2.0
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=22.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-1.5

# Switch to relative mode while retracted
G91
G1 Z-10.0
VERIFY_AXIS_POSITION AXIS=z EXPECTED=12.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-1.5

# Switch back to absolute mode
G90
G11
VERIFY_AXIS_POSITION AXIS=z EXPECTED=10.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=1.0

################################################ TESTING MOVE XY WHILE RETRACTED

# Test XY Move in Standard
G1 Z20.0
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=22.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-1.5

G1 X90.0 Y90.0
VERIFY_AXIS_POSITION AXIS=x EXPECTED=90.0
VERIFY_AXIS_POSITION AXIS=y EXPECTED=90.0

G11
VERIFY_AXIS_POSITION AXIS=z EXPECTED=20.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=1.0

G1 X100.0 Y100.0
VERIFY_AXIS_POSITION AXIS=x EXPECTED=100.0
VERIFY_AXIS_POSITION AXIS=y EXPECTED=100.0

####################################################### TESTING CLEAR RETRACTION
G1 X90.0 Y90.0 Z20.0

# Test CLEAR_RETRACTION while unretracted
CLEAR_RETRACTION

# Test CLEAR_RETRACTION while retracted
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=22.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-1.5
CLEAR_RETRACTION
VERIFY_AXIS_POSITION AXIS=z EXPECTED=22.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-1.5

# Unretract after clearing retraction
G11
VERIFY_AXIS_POSITION AXIS=z EXPECTED=22.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-1.5

# Test CLEAR_RETRACTION while retracted, 2nd go
SET_RETRACTION Z_HOP_HEIGHT=2.0
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=24.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-4.5
CLEAR_RETRACTION
VERIFY_AXIS_POSITION AXIS=z EXPECTED=24.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-4.5

# Unretract after clearing retraction and retracting
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=24.4
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-7.5
G11
VERIFY_AXIS_POSITION AXIS=z EXPECTED=24.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-4.5
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=24.4
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-7.5

# Test first move with z coordinate after retraction was cleared
G1 X100.0 Y100.0 Z28.0
VERIFY_AXIS_POSITION AXIS=x EXPECTED=100.0
VERIFY_AXIS_POSITION AXIS=y EXPECTED=100.0
VERIFY_AXIS_POSITION AXIS=z EXPECTED=28.4
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-7.5
G11
VERIFY_AXIS_POSITION AXIS=z EXPECTED=28.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-4.5
M118 Test successful!
